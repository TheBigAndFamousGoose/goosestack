<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GooseStack Dashboard</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-card: #141414;
            --bg-card-alt: #1a1a1a;
            --bg-input: #111;
            --border: #2a2a2a;
            --border-light: #333;
            --accent: #FF4500;
            --accent-hover: #ff5a1f;
            --accent-glow: rgba(255, 69, 0, 0.15);
            --accent-dim: rgba(255, 69, 0, 0.08);
            --text: #e8e8e8;
            --text-muted: #888;
            --text-dim: #555;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #eab308;
            --blue: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .shell { max-width: 1280px; margin: 0 auto; padding: 0 24px 40px; }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; margin-bottom: 4px;
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 50;
            background: var(--bg);
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo {
            font-size: 1.5rem; font-weight: 700; color: var(--accent);
            letter-spacing: -0.5px; white-space: nowrap;
            display: flex; align-items: center; gap: 8px;
        }
        .logo-emoji { font-size: 1.6rem; }
        .header-status { display: flex; gap: 16px; align-items: center; }
        .hstat {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.8rem; color: var(--text-muted);
        }
        .dot {
            width: 8px; height: 8px; border-radius: 50%;
            flex-shrink: 0; background: var(--text-dim);
            transition: background 0.3s;
        }
        .dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
        .dot.err { background: var(--red); box-shadow: 0 0 6px var(--red); }
        .dot.warn { background: var(--yellow); }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .gear-btn {
            background: none; border: 1px solid var(--border);
            border-radius: 8px; padding: 7px 10px; cursor: pointer;
            color: var(--text-muted); font-size: 1.1rem;
            transition: all 0.2s;
        }
        .gear-btn:hover { color: var(--accent); border-color: var(--accent); }

        /* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 2px; margin-bottom: 24px;
            border-bottom: 1px solid var(--border); overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-btn {
            padding: 13px 22px; background: none; border: none;
            color: var(--text-muted); cursor: pointer; font-size: 0.9rem;
            font-weight: 500; white-space: nowrap; transition: all 0.2s;
            border-bottom: 2px solid transparent; position: relative;
        }
        .tab-btn:hover { color: var(--text); background: var(--accent-dim); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-btn .tab-icon { margin-right: 6px; }

        /* ‚îÄ‚îÄ‚îÄ Panels ‚îÄ‚îÄ‚îÄ */
        .panel { display: none; animation: fadeUp 0.25s ease; }
        .panel.active { display: block; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 22px; margin-bottom: 20px;
        }
        .card-title {
            font-size: 0.85rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.6px; color: var(--text-muted); margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .card-title .ct-icon { color: var(--accent); font-size: 1rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }

        /* ‚îÄ‚îÄ‚îÄ Metric tiles ‚îÄ‚îÄ‚îÄ */
        .metric {
            background: var(--bg-card-alt); border-radius: 10px;
            padding: 16px; border-left: 3px solid var(--accent);
        }
        .metric-label {
            font-size: 0.75rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .metric-value {
            font-size: 1.05rem; font-weight: 600; word-break: break-all;
        }
        .metric-value.ok { color: var(--green); }
        .metric-value.err { color: var(--red); }
        .metric-value.warn { color: var(--yellow); }
        .metric-value.muted { color: var(--text-dim); }

        /* ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ */
        .chat-wrap {
            display: flex; flex-direction: column; height: calc(100vh - 220px);
            min-height: 420px; max-height: 700px;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 20px;
            background: var(--bg-input); border-radius: 12px 12px 0 0;
            border: 1px solid var(--border); border-bottom: none;
        }
        .msg { margin-bottom: 14px; display: flex; }
        .msg.user { justify-content: flex-end; }
        .bubble {
            max-width: 72%; padding: 12px 16px; border-radius: 16px;
            font-size: 0.95rem; line-height: 1.5; word-wrap: break-word;
            white-space: pre-wrap;
        }
        .bubble.user {
            background: var(--accent); color: #fff;
            border-bottom-right-radius: 4px;
        }
        .bubble.agent {
            background: #222; color: var(--text);
            border-bottom-left-radius: 4px;
        }
        .bubble.system {
            background: transparent; color: var(--text-dim);
            font-size: 0.85rem; font-style: italic; max-width: 100%;
        }
        .bubble.error-bubble {
            background: rgba(239,68,68,0.1); color: var(--red);
            border: 1px solid rgba(239,68,68,0.2);
        }
        .thinking-indicator {
            display: none; padding: 8px 16px; align-items: center; gap: 8px;
        }
        .thinking-indicator.visible { display: flex; }
        .thinking-dots span {
            display: inline-block; width: 7px; height: 7px;
            background: var(--accent); border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .chat-bar {
            display: flex; border: 1px solid var(--border);
            border-radius: 0 0 12px 12px; background: var(--bg-card);
        }
        .chat-input {
            flex: 1; padding: 14px 18px; background: none;
            border: none; color: var(--text); font-size: 0.95rem;
            outline: none; font-family: inherit;
        }
        .chat-input::placeholder { color: var(--text-dim); }
        .chat-send-btn, .chat-stop-btn {
            padding: 14px 22px; background: var(--accent); border: none;
            color: #fff; cursor: pointer; font-size: 0.95rem; font-weight: 600;
            border-radius: 0 0 12px 0; transition: background 0.2s;
        }
        .chat-send-btn:hover, .chat-stop-btn:hover { background: var(--accent-hover); }
        .chat-send-btn:disabled { background: #444; cursor: not-allowed; }
        .chat-stop-btn { background: var(--red); border-radius: 0; }
        .chat-stop-btn:hover { background: #dc2626; }
        .chat-stop-btn.hidden { display: none; }

        /* ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ */
        .cfg-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .cfg-row:last-child { border-bottom: none; }
        .cfg-key { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        .cfg-val {
            color: var(--text); font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.88rem; text-align: right; max-width: 60%; word-break: break-all;
        }
        .cfg-section {
            font-size: 0.8rem; color: var(--accent); font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 14px 0 6px; border-bottom: 1px solid var(--border);
        }

        /* ‚îÄ‚îÄ‚îÄ Logs ‚îÄ‚îÄ‚îÄ */
        .log-box {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 10px; height: 500px; overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.82rem; padding: 4px 0;
        }
        .log-line {
            padding: 5px 14px; border-bottom: 1px solid #1a1a1a;
            line-height: 1.5; white-space: pre-wrap; word-break: break-all;
        }
        .log-line:last-child { border-bottom: none; }
        .log-line.error { color: var(--red); background: rgba(239,68,68,0.06); }
        .log-line.warn { color: var(--yellow); background: rgba(234,179,8,0.05); }
        .log-line.info { color: #999; }
        .log-line.debug { color: #555; }
        .log-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .log-toolbar .badge {
            font-size: 0.75rem; background: var(--bg-card-alt);
            border: 1px solid var(--border); border-radius: 6px;
            padding: 4px 10px; color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ‚îÄ Security ‚îÄ‚îÄ‚îÄ */
        .sec-actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
        .sec-result {
            margin-top: 16px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 10px;
            padding: 16px; font-family: 'SF Mono', monospace;
            font-size: 0.82rem; max-height: 300px; overflow-y: auto;
            white-space: pre-wrap; color: #aaa; display: none;
        }
        .sec-result.visible { display: block; }

        /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
        .btn {
            padding: 10px 20px; background: var(--accent); border: none;
            border-radius: 8px; color: #fff; cursor: pointer;
            font-size: 0.9rem; font-weight: 500; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }
        .btn-outline {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
        }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .btn-sm { padding: 6px 14px; font-size: 0.82rem; }

        /* ‚îÄ‚îÄ‚îÄ Error / Empty states ‚îÄ‚îÄ‚îÄ */
        .empty-state {
            text-align: center; padding: 50px 20px; color: var(--text-dim);
        }
        .empty-state h3 { color: var(--text-muted); margin-bottom: 8px; font-size: 1.1rem; }
        .empty-state p { max-width: 400px; margin: 0 auto; line-height: 1.7; font-size: 0.9rem; }
        .error-banner {
            background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
            border-radius: 10px; padding: 16px 20px; margin-bottom: 20px;
            color: var(--red); display: none; font-size: 0.9rem;
        }
        .error-banner.visible { display: block; }

        /* ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 28px; max-width: 440px; width: 92%;
            transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal h3 { color: var(--accent); margin-bottom: 6px; font-size: 1.15rem; }
        .modal p { color: var(--text-muted); margin-bottom: 18px; font-size: 0.9rem; }
        .modal-input {
            width: 100%; padding: 12px 14px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text); font-family: 'SF Mono', monospace;
            font-size: 0.9rem; margin-bottom: 14px; outline: none;
        }
        .modal-input:focus { border-color: var(--accent); }
        .modal-input-label {
            font-size: 0.78rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.4px;
            margin-bottom: 6px; display: block;
        }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 6px; }

        /* ‚îÄ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ‚îÄ */
        .spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid var(--border); border-radius: 50%;
            border-top-color: var(--accent); animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-row {
            display: flex; align-items: center; gap: 10px;
            color: var(--text-muted); padding: 20px; font-size: 0.9rem;
        }

        /* ‚îÄ‚îÄ‚îÄ Refresh badge ‚îÄ‚îÄ‚îÄ */
        .refresh-ts {
            font-size: 0.72rem; color: var(--text-dim);
            text-align: right; padding: 4px 0 0;
        }

        /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 900px) {
            .grid-2 { grid-template-columns: 1fr; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .shell { padding: 0 14px 30px; }
            .header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .header-right { align-self: flex-end; position: absolute; right: 14px; top: 18px; }
            .header-status { flex-wrap: wrap; }
            .tabs { gap: 0; }
            .tab-btn { padding: 11px 14px; font-size: 0.82rem; }
            .grid-3 { grid-template-columns: 1fr 1fr; }
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .card { padding: 16px; }
            .bubble { max-width: 88%; }
            .chat-wrap { height: calc(100vh - 240px); min-height: 340px; }
            .cfg-row { flex-direction: column; align-items: flex-start; gap: 4px; }
            .cfg-val { text-align: left; max-width: 100%; }
        }
    </style>
</head>
<body>
<div class="shell">

    <!-- ‚ïê‚ïê‚ïê Billing Banner ‚ïê‚ïê‚ïê -->
    <div style="background:linear-gradient(135deg, rgba(255,69,0,0.12) 0%, rgba(255,69,0,0.04) 100%); border:1px solid rgba(255,69,0,0.25); border-radius:10px; padding:14px 20px; margin-bottom:16px; margin-top:12px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:1.2rem;">ü™ø</span>
            <span style="color:#e8e8e8; font-size:0.9rem;">This is the <strong>local agent dashboard</strong>. For billing &amp; credits, visit the web dashboard.</span>
        </div>
        <a href="https://goosestack.com/dashboard" target="_blank" rel="noopener" style="background:#FF4500; color:#fff; padding:7px 16px; border-radius:7px; font-size:0.82rem; font-weight:600; text-decoration:none; white-space:nowrap; transition:background 0.2s;">Billing &amp; Credits ‚Üí</a>
    </div>

    <!-- ‚ïê‚ïê‚ïê Header ‚ïê‚ïê‚ïê -->
    <header class="header">
        <div class="header-left">
            <div class="logo"><img src="../docs/logo-goose.png" alt="" style="height:28px;filter:invert(1);vertical-align:middle;margin-right:4px;"> GooseStack Dashboard</div>
            <div class="header-status">
                <div class="hstat"><span class="dot" id="dotGw"></span> <span id="lblGw">Gateway</span></div>
                <div class="hstat"><span class="dot" id="dotAgent"></span> <span id="lblAgent">Agent</span></div>
            </div>
        </div>
        <div class="header-right">
            <button class="gear-btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê Tabs ‚ïê‚ïê‚ïê -->
    <nav class="tabs" id="tabNav">
        <button class="tab-btn active" data-tab="overview"><span class="tab-icon">üìä</span>Status</button>
        <button class="tab-btn" data-tab="chat"><span class="tab-icon">üí¨</span>Chat</button>
        <button class="tab-btn" data-tab="config"><span class="tab-icon">‚öôÔ∏è</span>Config</button>
        <button class="tab-btn" data-tab="logs"><span class="tab-icon">üìù</span>Logs</button>
        <button class="tab-btn" data-tab="security"><span class="tab-icon">üîí</span>Security</button>
    </nav>

    <!-- ‚ïê‚ïê‚ïê Error Banner ‚ïê‚ïê‚ïê -->
    <div class="error-banner" id="errorBanner"></div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PANEL 1 ‚Äî Status Overview
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panelOverview">
        <div class="grid-2">
            <!-- Agent -->
            <div class="card">
                <div class="card-title"><span class="ct-icon">ü§ñ</span> Agent Status</div>
                <div class="grid-2" id="agentMetrics">
                    <div class="metric"><div class="metric-label">Status</div><div class="metric-value muted" id="mAgentStatus">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Uptime</div><div class="metric-value" id="mUptime">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Model</div><div class="metric-value" id="mModel">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Gateway Version</div><div class="metric-value" id="mVersion">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Channels</div><div class="metric-value" id="mChannels">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Memory Search</div><div class="metric-value" id="mMemory">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Last Activity</div><div class="metric-value" id="mLastActivity">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Session</div><div class="metric-value" id="mSession">‚Äî</div></div>
                </div>
            </div>
            <!-- System -->
            <div class="card">
                <div class="card-title"><span class="ct-icon">üñ•Ô∏è</span> System Info</div>
                <div class="grid-2" id="sysMetrics">
                    <div class="metric"><div class="metric-label">Hostname</div><div class="metric-value" id="mHostname">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">macOS</div><div class="metric-value" id="mOS">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Chip</div><div class="metric-value" id="mChip">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">RAM</div><div class="metric-value" id="mRAM">‚Äî</div></div>
                </div>
            </div>
        </div>
        <div class="refresh-ts" id="overviewTs"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PANEL 2 ‚Äî Chat
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panelChat">
        <div class="card" style="padding:0; overflow:hidden;">
            <div class="chat-wrap">
                <div class="chat-messages" id="chatMessages">
                    <div class="msg"><div class="bubble system">Send a message to chat with your agent via the gateway WebSocket API.</div></div>
                </div>
                <div class="thinking-indicator" id="thinkingIndicator">
                    <div class="thinking-dots"><span></span><span></span><span></span></div>
                    <span style="color:var(--text-dim);font-size:0.85rem;">Thinking‚Ä¶</span>
                </div>
                <div class="chat-bar">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message‚Ä¶" autocomplete="off">
                    <button class="chat-stop-btn hidden" id="chatStopBtn">Stop</button>
                    <button class="chat-send-btn" id="chatSendBtn" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PANEL 3 ‚Äî Configuration
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panelConfig">
        <div class="card" id="configCard">
            <div class="card-title"><span class="ct-icon">‚öôÔ∏è</span> Configuration <span style="font-size:0.72rem;color:var(--text-dim);margin-left:auto;">(read-only)</span></div>
            <div id="configContent"><div class="loading-row"><span class="spinner"></span> Loading configuration‚Ä¶</div></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PANEL 4 ‚Äî Logs
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panelLogs">
        <div class="card">
            <div class="log-toolbar">
                <div class="card-title" style="margin-bottom:0;"><span class="ct-icon">üìù</span> Gateway Logs</div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span class="badge" id="logCount">0 entries</span>
                    <button class="btn btn-outline btn-sm" id="btnRefreshLogs">‚Üª Refresh</button>
                </div>
            </div>
            <div class="log-box" id="logBox">
                <div class="log-line info">Waiting for logs‚Ä¶</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PANEL 5 ‚Äî Security
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panelSecurity">
        <div class="grid-2">
            <div class="card">
                <div class="card-title"><span class="ct-icon">üõ°Ô∏è</span> Security Status</div>
                <div class="grid-2">
                    <div class="metric"><div class="metric-label">ClawSec</div><div class="metric-value" id="mClawsec">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Soul Guardian</div><div class="metric-value" id="mSoulGuardian">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">Last Audit</div><div class="metric-value" id="mLastAudit">‚Äî</div></div>
                    <div class="metric"><div class="metric-label">File Integrity</div><div class="metric-value" id="mFileIntegrity">‚Äî</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title"><span class="ct-icon">üõ†Ô∏è</span> Security Actions</div>
                <p style="color:var(--text-muted);font-size:0.88rem;margin-bottom:14px;">
                    Security checks are not available via the gateway RPC. Run these commands manually in your terminal:
                </p>
                <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:14px;font-family:'SF Mono',monospace;font-size:0.85rem;color:var(--text-muted);line-height:2;">
                    <div><span style="color:var(--accent);">$</span> openclaw security audit</div>
                    <div><span style="color:var(--accent);">$</span> openclaw soul-guardian check</div>
                    <div><span style="color:var(--accent);">$</span> openclaw security integrity</div>
                </div>
                <div class="sec-actions" style="margin-top:16px;">
                    <button class="btn" id="btnAudit">üîç Run Security Audit</button>
                    <button class="btn btn-outline" id="btnIntegrity">üîê Check File Integrity</button>
                </div>
                <div class="sec-result" id="secResult"></div>
            </div>
        </div>
    </div>

</div><!-- .shell -->

<!-- ‚ïê‚ïê‚ïê Settings Modal ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalSettings">
    <div class="modal">
        <h3>Dashboard Settings</h3>
        <p>Configure your gateway connection.</p>
        <label class="modal-input-label">Gateway URL</label>
        <input class="modal-input" id="inputGwUrl" placeholder="http://localhost:18789">
        <label class="modal-input-label">Bearer Token</label>
        <input class="modal-input" id="inputToken" type="password" placeholder="Enter token‚Ä¶">
        <div class="modal-footer">
            <button class="btn btn-outline" id="btnSettingsCancel">Cancel</button>
            <button class="btn" id="btnSettingsSave">Save &amp; Connect</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê Token Prompt (first visit) ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalToken">
    <div class="modal">
        <h3>ü™ø Welcome to GooseStack</h3>
        <p>Enter your OpenClaw gateway bearer token to connect.</p>
        <label class="modal-input-label">Gateway URL</label>
        <input class="modal-input" id="firstGwUrl" value="http://localhost:18789" placeholder="http://localhost:18789">
        <label class="modal-input-label">Bearer Token</label>
        <input class="modal-input" id="firstToken" type="password" placeholder="Paste your token here‚Ä¶">
        <div class="modal-footer">
            <button class="btn" id="btnFirstConnect">Connect</button>
        </div>
    </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GooseStack Dashboard ‚Äî WebSocket Build
   Connects to OpenClaw Gateway via WS RPC
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

(() => {
'use strict';

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let gwUrl = localStorage.getItem('gsd_gw_url') || 'http://localhost:18789';
let token = localStorage.getItem('gsd_token') || '';
let connected = false;
let ws = null;
let wsReady = false;
let reqId = 0;
let pendingRpc = {};      // id ‚Üí { resolve, reject, timer }
let statusTimer = null;
let logsTimer = null;
let chatBusy = false;
let currentRunId = null;
let streamBubble = null;
let streamText = '';
let activeTab = 'overview';
let logsCursor = null;
let allLogLines = [];
let configLoaded = false;
let chatHistoryLoaded = false;
let reconnectTimer = null;
let reconnectDelay = 1000;

// ‚îÄ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ‚îÄ
const $ = (s, p) => (p || document).querySelector(s);
const $$ = (s, p) => [...(p || document).querySelectorAll(s)];
const el = (tag, cls, html) => { const e = document.createElement(tag); if (cls) e.className = cls; if (html !== undefined) e.innerHTML = html; return e; };

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
    setupTabs();
    setupSettings();
    setupChat();
    setupSecurity();
    setupLogRefresh();

    if (!token) {
        openModal('modalToken');
    } else {
        boot();
    }
});

// ‚îÄ‚îÄ‚îÄ WebSocket URL from gateway URL ‚îÄ‚îÄ‚îÄ
function getWsUrl() {
    return gwUrl.replace(/^http:\/\//, 'ws://').replace(/^https:\/\//, 'wss://');
}

// ‚îÄ‚îÄ‚îÄ RPC call over WebSocket ‚îÄ‚îÄ‚îÄ
function rpc(method, params = {}, timeoutMs = 10000) {
    return new Promise((resolve, reject) => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            reject(new Error('WebSocket not connected'));
            return;
        }
        const id = String(++reqId);
        const timer = setTimeout(() => {
            delete pendingRpc[id];
            reject(new Error(`RPC timeout: ${method}`));
        }, timeoutMs);

        pendingRpc[id] = { resolve, reject, timer };
        ws.send(JSON.stringify({ type: 'req', id, method, params }));
    });
}

// ‚îÄ‚îÄ‚îÄ WebSocket connection ‚îÄ‚îÄ‚îÄ
function wsConnect() {
    if (ws) {
        try { ws.close(); } catch {}
        ws = null;
    }
    wsReady = false;
    const url = getWsUrl();
    console.log('[GSD] Connecting to', url);

    try {
        ws = new WebSocket(url);
    } catch (e) {
        console.error('[GSD] WebSocket create error:', e);
        setGwDot(false); setAgentDot(false);
        showError(`Cannot create WebSocket to ${url}: ${e.message}`);
        scheduleReconnect();
        return;
    }

    ws.onopen = () => {
        console.log('[GSD] WebSocket open, sending connect handshake');
        clearReconnect();
        // Send connect handshake
        const connectId = String(++reqId);
        const timer = setTimeout(() => {
            delete pendingRpc[connectId];
            console.error('[GSD] Connect handshake timeout');
            showError('WebSocket connect handshake timed out.');
            setGwDot(false);
        }, 15000);

        pendingRpc[connectId] = {
            resolve: (payload) => {
                console.log('[GSD] Connected!', payload);
                window._gsdHello = payload;
                wsReady = true;
                connected = true;
                reconnectDelay = 1000;
                setGwDot(true);
                hideError();
                enableChat(true);
                // Kick off initial data loads
                pollStatus();
                startPolling();
                if (activeTab === 'config') loadConfig();
                if (activeTab === 'logs') loadLogs();
                if (activeTab === 'chat' && !chatHistoryLoaded) loadChatHistory();
            },
            reject: (err) => {
                console.error('[GSD] Connect handshake failed:', err);
                showError('WebSocket handshake failed: ' + err.message);
                setGwDot(false);
            },
            timer
        };

        ws.send(JSON.stringify({
            type: 'req',
            id: connectId,
            method: 'connect',
            params: {
                minProtocol: 3,
                maxProtocol: 3,
                client: { id: 'webchat-ui', version: '1.0', platform: 'web', mode: 'webchat' },
                role: 'operator',
                scopes: ['operator.admin'],
                auth: { token },
                userAgent: 'GooseStack Dashboard'
            }
        }));
    };

    ws.onmessage = (ev) => {
        let msg;
        try { msg = JSON.parse(ev.data); } catch { return; }
        handleWsMessage(msg);
    };

    ws.onerror = (ev) => {
        console.error('[GSD] WebSocket error', ev);
    };

    ws.onclose = (ev) => {
        console.log('[GSD] WebSocket closed:', ev.code, ev.reason);
        wsReady = false;
        connected = false;
        setGwDot(false); setAgentDot(false);
        enableChat(false);
        // Reject all pending RPCs
        for (const id of Object.keys(pendingRpc)) {
            clearTimeout(pendingRpc[id].timer);
            pendingRpc[id].reject(new Error('WebSocket closed'));
            delete pendingRpc[id];
        }
        if (token) {
            showError('WebSocket disconnected. Reconnecting‚Ä¶');
            scheduleReconnect();
        }
    };
}

function handleWsMessage(msg) {
    // Response to a pending RPC
    if (msg.type === 'res' && msg.id && pendingRpc[msg.id]) {
        const p = pendingRpc[msg.id];
        clearTimeout(p.timer);
        delete pendingRpc[msg.id];
        if (msg.ok || msg.ok === undefined) {
            p.resolve(msg.payload || msg);
        } else {
            p.reject(new Error(msg.error || msg.message || 'RPC error'));
        }
        return;
    }

    // Server-push events
    if (msg.type === 'event') {
        handleEvent(msg.event, msg.payload || {});
        return;
    }
}

function handleEvent(event, payload) {
    // Handle connect challenge ‚Äî retry connect
    if (event === 'connect.challenge') {
        console.log('[GSD] Got connect.challenge, retrying connect');
        // Re-send connect (the nonce is handled server-side for token auth)
        const connectId = String(++reqId);
        const timer = setTimeout(() => { delete pendingRpc[connectId]; }, 15000);
        pendingRpc[connectId] = {
            resolve: (p) => {
                wsReady = true; connected = true; reconnectDelay = 1000;
                setGwDot(true); hideError(); enableChat(true);
                pollStatus(); startPolling();
            },
            reject: () => {},
            timer
        };
        ws.send(JSON.stringify({
            type: 'req', id: connectId, method: 'connect',
            params: {
                minProtocol: 3, maxProtocol: 3,
                client: { id: 'webchat-ui', version: '1.0', platform: 'web', mode: 'webchat' },
                role: 'operator', scopes: ['operator.admin'],
                auth: { token }, userAgent: 'GooseStack Dashboard'
            }
        }));
        return;
    }

    // Chat streaming events
    if (event === 'chat') {
        handleChatEvent(payload);
        return;
    }
}

// ‚îÄ‚îÄ‚îÄ Reconnect ‚îÄ‚îÄ‚îÄ
function scheduleReconnect() {
    clearReconnect();
    reconnectTimer = setTimeout(() => {
        console.log('[GSD] Reconnecting‚Ä¶');
        wsConnect();
        reconnectDelay = Math.min(reconnectDelay * 1.5, 30000);
    }, reconnectDelay);
}

function clearReconnect() {
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
}

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ
function boot() {
    stopPolling();
    wsConnect();
}

function stopPolling() {
    clearInterval(statusTimer); statusTimer = null;
    clearInterval(logsTimer); logsTimer = null;
}

function startPolling() {
    stopPolling();
    // Status polling every 5s
    statusTimer = setInterval(() => {
        if (wsReady) pollStatus();
    }, 5000);
    // Logs polling every 2s when on logs tab
    logsTimer = setInterval(() => {
        if (wsReady && activeTab === 'logs') loadLogs();
    }, 2000);
}

async function pollStatus() {
    try {
        const [statusData, healthData] = await Promise.all([
            rpc('status').catch(() => null),
            rpc('health').catch(() => null)
        ]);
        connected = true;
        setGwDot(true);
        hideError();
        renderStatus(statusData, healthData);
    } catch (e) {
        // Don't mark disconnected on single RPC fail
        console.warn('[GSD] Status poll error:', e.message);
    }
}

// ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ
function setupTabs() {
    const btns = $$('.tab-btn');
    const panels = $$('.panel');
    btns.forEach(b => b.addEventListener('click', () => {
        btns.forEach(x => x.classList.remove('active'));
        panels.forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        const t = b.dataset.tab;
        activeTab = t;
        $(`#panel${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.add('active');
        if (t === 'config' && wsReady) loadConfig();
        if (t === 'logs' && wsReady) loadLogs();
        if (t === 'chat' && wsReady && !chatHistoryLoaded) loadChatHistory();
        if (t === 'security' && wsReady) loadSecurity();
    }));
}

// ‚îÄ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ‚îÄ
function setupSettings() {
    $('#btnSettings').addEventListener('click', () => {
        $('#inputGwUrl').value = gwUrl;
        $('#inputToken').value = token;
        openModal('modalSettings');
    });
    $('#btnSettingsCancel').addEventListener('click', () => closeModal('modalSettings'));
    $('#btnSettingsSave').addEventListener('click', () => {
        const u = $('#inputGwUrl').value.trim().replace(/\/+$/, '');
        const t = $('#inputToken').value.trim();
        if (!u || !t) return;
        gwUrl = u; token = t;
        localStorage.setItem('gsd_gw_url', gwUrl);
        localStorage.setItem('gsd_token', token);
        closeModal('modalSettings');
        configLoaded = false;
        chatHistoryLoaded = false;
        logsCursor = null;
        allLogLines = [];
        boot();
    });

    // First-visit modal
    $('#btnFirstConnect').addEventListener('click', () => {
        const u = $('#firstGwUrl').value.trim().replace(/\/+$/, '') || 'http://localhost:18789';
        const t = $('#firstToken').value.trim();
        if (!t) { $('#firstToken').style.borderColor = 'var(--red)'; return; }
        gwUrl = u; token = t;
        localStorage.setItem('gsd_gw_url', gwUrl);
        localStorage.setItem('gsd_token', token);
        closeModal('modalToken');
        boot();
    });
    // Enter key for first token
    $('#firstToken').addEventListener('keydown', e => { if (e.key === 'Enter') $('#btnFirstConnect').click(); });
    $('#inputToken').addEventListener('keydown', e => { if (e.key === 'Enter') $('#btnSettingsSave').click(); });
}

function openModal(id) { $(`#${id}`).classList.add('open'); }
function closeModal(id) { $(`#${id}`).classList.remove('open'); }

// ‚îÄ‚îÄ‚îÄ Status rendering ‚îÄ‚îÄ‚îÄ
function renderStatus(statusData, healthData) {
    console.log('[GSD] status:', JSON.stringify(statusData));
    console.log('[GSD] health:', JSON.stringify(healthData));
    const d = { ...(statusData || {}), ...(healthData || {}) };

    // Agent dot ‚Äî health.ok means the gateway is healthy and agent is operational
    const running = d.ok === true || d.agent === 'running' || d.agentRunning || d.status === 'running';
    setAgentDot(running);

    const s = (id, v) => { const el = $(`#${id}`); if (el) el.textContent = v || '‚Äî'; };
    const sc = (id, v, cls) => { const el = $(`#${id}`); if (el) { el.textContent = v || '‚Äî'; el.className = 'metric-value ' + (cls || ''); } };

    // Extract from nested payloads
    const sessDefaults = statusData?.sessions?.defaults || {};
    const recentSessions = statusData?.sessions?.recent || [];
    const mainSession = recentSessions.find(r => r.key === 'agent:main:main');
    const channelSummary = statusData?.channelSummary || [];
    const channelLabels = healthData?.channelLabels || {};
    const agents = healthData?.agents || [];
    const mainAgent = agents.find(a => a.isDefault) || agents[0];
    const server = window._gsdHello?.server || {};

    // Agent metrics
    sc('mAgentStatus', running ? 'Running' : 'Stopped', running ? 'ok' : 'err');
    s('mUptime', server.uptime ? formatUptime(server.uptime) : (mainSession ? formatTime(Date.now() - mainSession.age) : '‚Äî'));
    s('mModel', sessDefaults.model || d.model || '‚Äî');
    s('mVersion', server.version || d.version || '‚Äî');
    s('mChannels', Object.values(channelLabels).join(', ') || channelSummary[0] || formatChannels(d.channels) || '‚Äî');
    s('mMemory', d.memorySearch || (sessDefaults.model ? 'Local' : '‚Äî'));
    s('mLastActivity', mainSession ? formatTime(Date.now() - mainSession.age) : '‚Äî');
    s('mSession', mainSession ? `${mainSession.percentUsed}% used (${mainSession.totalTokens} tokens)` : `${recentSessions.length} sessions`);

    // System info ‚Äî from hello snapshot or server
    s('mHostname', server.hostname || d.hostname || '‚Äî');
    s('mOS', server.os || d.os || '‚Äî');
    s('mChip', server.arch || d.chip || '‚Äî');
    s('mRAM', server.ram || d.ram || '‚Äî');

    // Refresh ts
    $('#overviewTs').textContent = `Last refreshed: ${new Date().toLocaleTimeString()} (via WebSocket)`;
}

function setGwDot(ok) {
    const d = $('#dotGw');
    d.className = 'dot ' + (ok ? 'ok' : 'err');
    $('#lblGw').textContent = 'Gateway: ' + (ok ? 'Connected' : 'Disconnected');
}
function setAgentDot(ok) {
    const d = $('#dotAgent');
    d.className = 'dot ' + (ok ? 'ok' : 'err');
    $('#lblAgent').textContent = 'Agent: ' + (ok ? 'Running' : 'Stopped');
}

function formatUptime(v) {
    if (!v) return '‚Äî';
    if (typeof v === 'string') return v;
    let sec = typeof v === 'number' ? (v > 1e10 ? v / 1000 : v) : 0;
    if (sec < 60) return `${Math.floor(sec)}s`;
    if (sec < 3600) return `${Math.floor(sec / 60)}m ${Math.floor(sec % 60)}s`;
    const h = Math.floor(sec / 3600); const m = Math.floor((sec % 3600) / 60);
    return `${h}h ${m}m`;
}

function formatChannels(ch) {
    if (!ch) return '‚Äî';
    if (typeof ch === 'string') return ch;
    if (Array.isArray(ch)) return ch.length ? ch.join(', ') : 'None';
    if (typeof ch === 'object') {
        // Object like {telegram: {...}, webchat: {...}} ‚Äî extract enabled channel names
        const names = Object.keys(ch).filter(k => ch[k]?.enabled !== false);
        return names.length ? names.join(', ') : 'None';
    }
    return String(ch);
}

function formatTime(t) {
    if (!t) return '‚Äî';
    try {
        const d = new Date(t);
        if (isNaN(d)) return t;
        const now = Date.now();
        const diff = (now - d.getTime()) / 1000;
        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return d.toLocaleString();
    } catch { return t; }
}

// ‚îÄ‚îÄ‚îÄ Error banner ‚îÄ‚îÄ‚îÄ
function showError(msg) {
    const b = $('#errorBanner');
    b.textContent = '‚ö†Ô∏è ' + msg;
    b.classList.add('visible');
}
function hideError() { $('#errorBanner').classList.remove('visible'); }

// ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ
function setupChat() {
    const input = $('#chatInput');
    const sendBtn = $('#chatSendBtn');
    const stopBtn = $('#chatStopBtn');

    const send = () => {
        const msg = input.value.trim();
        if (!msg || chatBusy) return;
        sendChat(msg);
        input.value = '';
        sendBtn.disabled = true;
    };
    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });
    input.addEventListener('input', () => {
        sendBtn.disabled = !input.value.trim() || !connected || chatBusy;
    });

    // Stop button
    stopBtn.addEventListener('click', () => {
        abortChat();
    });
}

function enableChat(on) {
    const sendBtn = $('#chatSendBtn');
    sendBtn.disabled = !on || !$('#chatInput').value.trim() || chatBusy;
    $('#chatInput').disabled = !on;
    if (!on) $('#chatInput').placeholder = 'Connect to gateway first‚Ä¶';
    else $('#chatInput').placeholder = 'Type a message‚Ä¶';
}

function addMsg(type, text) {
    const wrap = $('#chatMessages');
    const m = el('div', 'msg' + (type === 'user' ? ' user' : ''));
    const b = el('div', 'bubble ' + type);
    b.textContent = text;
    m.appendChild(b);
    wrap.appendChild(m);
    wrap.scrollTop = wrap.scrollHeight;
    return b;
}

async function loadChatHistory() {
    if (!wsReady) return;
    try {
        const data = await rpc('chat.history', { sessionKey: 'agent:main', limit: 50 });
        const msgs = data.messages || data.entries || data.history || [];
        if (msgs.length) {
            const wrap = $('#chatMessages');
            wrap.innerHTML = ''; // Clear placeholder
            for (const m of msgs) {
                const role = m.role || m.from || m.type || 'agent';
                const text = m.content || m.text || m.message || '';
                if (!text) continue;
                const isUser = role === 'user' || role === 'human';
                addMsg(isUser ? 'user' : 'agent', text);
            }
        }
        chatHistoryLoaded = true;
    } catch (e) {
        console.warn('[GSD] Failed to load chat history:', e.message);
        // Not critical, continue
    }
}

async function sendChat(message) {
    addMsg('user', message);
    chatBusy = true;
    streamBubble = null;
    streamText = '';
    currentRunId = null;
    $('#chatSendBtn').disabled = true;
    $('#chatStopBtn').classList.remove('hidden');
    $('#thinkingIndicator').classList.add('visible');

    try {
        const data = await rpc('chat.send', {
            sessionKey: 'agent:main',
            message: message,
            deliver: false
        }, 30000);

        currentRunId = data.runId || data.run_id || null;
        // The actual response will stream in via chat events
        // If we got a direct response (no streaming), show it
        if (data.response || data.reply || data.text || data.content) {
            finishStream();
            const reply = data.response || data.reply || data.text || data.content;
            addMsg('agent', reply);
            chatDone();
        }
        // Otherwise, wait for streaming events...
    } catch (e) {
        finishStream();
        const wrap = $('#chatMessages');
        const m = el('div', 'msg');
        const b = el('div', 'bubble error-bubble');
        b.textContent = `Error: ${e.message}`;
        m.appendChild(b);
        wrap.appendChild(m);
        wrap.scrollTop = wrap.scrollHeight;
        chatDone();
    }
}

function handleChatEvent(payload) {
    const state = payload.state;

    if (state === 'delta') {
        // Streaming delta
        const msg = payload.message || {};
        // Content can be in various shapes
        let chunk = '';
        if (typeof msg.content === 'string') {
            chunk = msg.content;
        } else if (Array.isArray(msg.content)) {
            for (const part of msg.content) {
                if (part.type === 'text' && part.text) chunk += part.text;
                else if (typeof part === 'string') chunk += part;
            }
        } else if (msg.text) {
            chunk = msg.text;
        } else if (msg.delta) {
            chunk = msg.delta;
        } else if (payload.text) {
            chunk = payload.text;
        } else if (payload.delta) {
            chunk = payload.delta;
        }

        if (chunk) {
            streamText += chunk;
            if (!streamBubble) {
                // Create the bubble on first delta
                $('#thinkingIndicator').classList.remove('visible');
                const wrap = $('#chatMessages');
                const m = el('div', 'msg');
                streamBubble = el('div', 'bubble agent');
                m.appendChild(streamBubble);
                wrap.appendChild(m);
            }
            streamBubble.textContent = streamText;
            $('#chatMessages').scrollTop = $('#chatMessages').scrollHeight;
        }
    } else if (state === 'final' || state === 'done' || state === 'complete') {
        // Stream finished
        if (!streamBubble && !streamText) {
            // Got final without any deltas ‚Äî check for full message
            const msg = payload.message || {};
            let fullText = '';
            if (typeof msg.content === 'string') fullText = msg.content;
            else if (Array.isArray(msg.content)) {
                for (const part of msg.content) {
                    if (part.type === 'text' && part.text) fullText += part.text;
                    else if (typeof part === 'string') fullText += part;
                }
            } else if (msg.text) fullText = msg.text;

            if (fullText) {
                addMsg('agent', fullText);
            } else if (payload.text) {
                addMsg('agent', payload.text);
            }
        }
        finishStream();
        chatDone();
    } else if (state === 'error') {
        finishStream();
        const errMsg = payload.error || payload.message || 'Unknown streaming error';
        const wrap = $('#chatMessages');
        const m = el('div', 'msg');
        const b = el('div', 'bubble error-bubble');
        b.textContent = `Error: ${typeof errMsg === 'object' ? JSON.stringify(errMsg) : errMsg}`;
        m.appendChild(b);
        wrap.appendChild(m);
        wrap.scrollTop = wrap.scrollHeight;
        chatDone();
    }
    // Other states (thinking, etc) ‚Äî just keep the indicator
}

function finishStream() {
    streamBubble = null;
    streamText = '';
    currentRunId = null;
}

function chatDone() {
    chatBusy = false;
    $('#thinkingIndicator').classList.remove('visible');
    $('#chatStopBtn').classList.add('hidden');
    $('#chatSendBtn').disabled = !$('#chatInput').value.trim() || !connected;
}

async function abortChat() {
    try {
        await rpc('chat.abort', { sessionKey: 'agent:main' }, 5000);
    } catch (e) {
        console.warn('[GSD] Abort error:', e.message);
    }
    finishStream();
    if (!streamText) {
        addMsg('system', '(generation aborted)');
    }
    chatDone();
}

// ‚îÄ‚îÄ‚îÄ Configuration ‚îÄ‚îÄ‚îÄ
async function loadConfig() {
    if (configLoaded) return;
    const box = $('#configContent');

    if (!wsReady) {
        box.innerHTML = '<div class="empty-state"><h3>Not Connected</h3><p>Connect to the gateway to view configuration.</p></div>';
        return;
    }

    box.innerHTML = '<div class="loading-row"><span class="spinner"></span> Loading configuration‚Ä¶</div>';

    try {
        const data = await rpc('config.get');
        renderConfig(data);
        configLoaded = true;
    } catch (e) {
        box.innerHTML = `
            <div class="empty-state">
                <h3>Configuration Unavailable</h3>
                <p>Could not load config via <code>config.get</code> RPC.<br>
                Error: ${escHtml(e.message)}</p>
                <p style="margin-top:12px;color:var(--text-dim);font-size:0.82rem;">
                    Check your OpenClaw config file at:<br>
                    <code>~/.openclaw/config.yaml</code>
                </p>
            </div>`;
    }
}

function renderConfig(d) {
    const box = $('#configContent');

    const mapField = (label, ...keys) => {
        for (const k of keys) {
            let v = d[k]; if (v !== undefined && v !== null) return { label, value: typeof v === 'object' ? JSON.stringify(v) : String(v) };
        }
        return null;
    };

    const fields = [
        mapField('Model', 'model', 'defaultModel', 'default_model'),
        mapField('Thinking Mode', 'thinking', 'thinkingMode', 'thinking_mode'),
        mapField('Subagent Model', 'subagentModel', 'subagent_model'),
        mapField('Channels', 'channels', 'connectedChannels', 'connected_channels'),
        mapField('Workspace Path', 'workspace', 'workspacePath', 'workspace_path'),
        mapField('Gateway Port', 'port', 'gatewayPort', 'gateway_port'),
        mapField('Security Level', 'security', 'securityLevel', 'security_level'),
        mapField('Exec Security', 'execSecurity', 'exec_security'),
        mapField('Browser Security', 'browserSecurity', 'browser_security'),
        mapField('Version', 'version', 'gatewayVersion', 'gateway_version'),
    ];

    let html = '';
    for (const f of fields) {
        if (f) {
            let displayVal = f.value;
            if (displayVal.startsWith('[') || displayVal.startsWith('{')) {
                try {
                    const arr = JSON.parse(displayVal);
                    displayVal = Array.isArray(arr) ? arr.join(', ') : displayVal;
                } catch {}
            }
            html += `<div class="cfg-row"><span class="cfg-key">${f.label}</span><span class="cfg-val">${escHtml(displayVal)}</span></div>`;
        }
    }

    // Dump remaining keys
    const mapped = new Set(['model','defaultModel','default_model','thinking','thinkingMode','thinking_mode',
        'subagentModel','subagent_model','channels','connectedChannels','connected_channels',
        'workspace','workspacePath','workspace_path','port','gatewayPort','gateway_port',
        'security','securityLevel','security_level','execSecurity','exec_security',
        'browserSecurity','browser_security','version','gatewayVersion','gateway_version']);
    const extra = Object.keys(d).filter(k => !mapped.has(k));
    if (extra.length) {
        html += '<div class="cfg-section">Other</div>';
        for (const k of extra) {
            let v = d[k];
            if (typeof v === 'object') v = JSON.stringify(v, null, 2);
            html += `<div class="cfg-row"><span class="cfg-key">${escHtml(k)}</span><span class="cfg-val">${escHtml(String(v))}</span></div>`;
        }
    }

    if (!html) {
        html = '<div class="empty-state"><p>No configuration data returned.</p></div>';
    }

    box.innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ Logs ‚îÄ‚îÄ‚îÄ
async function loadLogs() {
    if (!wsReady) {
        $('#logBox').innerHTML = '<div class="log-line info">Connect to the gateway first.</div>';
        return;
    }

    try {
        const params = { limit: 200 };
        if (logsCursor) params.cursor = logsCursor;
        const data = await rpc('logs.tail', params);
        const lines = data.lines || data.logs || data.entries || [];
        if (data.cursor) logsCursor = data.cursor;

        if (logsCursor && allLogLines.length > 0) {
            // Append new lines (incremental)
            allLogLines = allLogLines.concat(lines);
        } else {
            allLogLines = lines;
        }

        // Keep a reasonable buffer
        if (allLogLines.length > 2000) {
            allLogLines = allLogLines.slice(-1500);
        }

        renderLogs(allLogLines);
    } catch (e) {
        if (allLogLines.length === 0) {
            $('#logBox').innerHTML = `<div class="log-line error">Failed to load logs: ${escHtml(e.message)}</div>`;
        }
    }
}

function renderLogs(logs) {
    const box = $('#logBox');
    if (!logs.length) {
        box.innerHTML = '<div class="log-line info">No log entries.</div>';
        $('#logCount').textContent = '0 entries';
        return;
    }

    const wasAtBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 50;

    box.innerHTML = logs.map(l => {
        const msg = l.message || l.msg || l.text || (typeof l === 'string' ? l : JSON.stringify(l));
        const lvl = detectLogLevel(msg, l.level);
        const ts = l.timestamp || l.time || l.ts || '';
        const tsStr = ts ? `[${formatLogTime(ts)}] ` : '';
        return `<div class="log-line ${lvl}">${escHtml(tsStr + msg)}</div>`;
    }).join('');

    if (wasAtBottom) box.scrollTop = box.scrollHeight;
    $('#logCount').textContent = `${logs.length} entries`;
}

function detectLogLevel(msg, level) {
    if (level) {
        const l = level.toLowerCase();
        if (l.includes('err') || l.includes('fatal')) return 'error';
        if (l.includes('warn')) return 'warn';
        if (l.includes('debug') || l.includes('trace')) return 'debug';
        return 'info';
    }
    const m = msg.toLowerCase();
    if (m.includes('error') || m.includes('fatal') || m.includes('exception')) return 'error';
    if (m.includes('warn')) return 'warn';
    if (m.includes('debug')) return 'debug';
    return 'info';
}

function formatLogTime(t) {
    try {
        const d = new Date(t);
        return isNaN(d) ? t : d.toLocaleTimeString();
    } catch { return t; }
}

function setupLogRefresh() {
    $('#btnRefreshLogs').addEventListener('click', () => {
        logsCursor = null;
        allLogLines = [];
        loadLogs();
    });
}

// ‚îÄ‚îÄ‚îÄ Security ‚îÄ‚îÄ‚îÄ
async function loadSecurity() {
    if (!wsReady) return;

    // Try to get security info from status
    try {
        const d = await rpc('status');
        if (d.security) {
            setText('mClawsec', d.security.clawsec || 'Unknown');
            setText('mSoulGuardian', d.security.soulGuardian || d.security.soul_guardian || 'Unknown');
            setText('mLastAudit', d.security.lastAudit || d.security.last_audit || 'Unknown');
            setText('mFileIntegrity', d.security.fileIntegrity || d.security.file_integrity || 'Unknown');
            return;
        }
        // Maybe top-level
        setText('mClawsec', d.clawsec || 'Unknown');
        setText('mSoulGuardian', d.soulGuardian || d.soul_guardian || 'Unknown');
        setText('mLastAudit', d.lastAudit || d.last_audit || 'Unknown');
        setText('mFileIntegrity', d.fileIntegrity || d.file_integrity || 'Unknown');
    } catch {
        setText('mClawsec', 'Unavailable');
        setText('mSoulGuardian', 'Unavailable');
        setText('mLastAudit', 'Unavailable');
        setText('mFileIntegrity', 'Unavailable');
    }
}

function setupSecurity() {
    $('#btnAudit').addEventListener('click', async () => {
        const btn = $('#btnAudit');
        const result = $('#secResult');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Running‚Ä¶';
        result.classList.add('visible');
        result.textContent = 'Security audit is not available via gateway RPC.\n\nRun manually in terminal:\n  openclaw security audit';

        // Try sending it as a chat message as a workaround
        try {
            if (wsReady) {
                const data = await rpc('chat.send', {
                    sessionKey: 'agent:main',
                    message: 'Run a security audit of the OpenClaw installation',
                    deliver: false
                }, 15000);
                result.textContent += '\n\nSent audit request to agent. Check the Chat tab for results.';
            }
        } catch (e) {
            // Silently ignore
        }

        btn.disabled = false;
        btn.innerHTML = 'üîç Run Security Audit';
    });

    $('#btnIntegrity').addEventListener('click', async () => {
        const btn = $('#btnIntegrity');
        const result = $('#secResult');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Checking‚Ä¶';
        result.classList.add('visible');
        result.textContent = 'File integrity check is not available via gateway RPC.\n\nRun manually in terminal:\n  openclaw soul-guardian check';

        btn.disabled = false;
        btn.innerHTML = 'üîê Check File Integrity';
    });
}

// ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ
function setText(id, v) { const e = $(`#${id}`); if (e) e.textContent = v || '‚Äî'; }
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

})();
</script>
</body>
</html>
